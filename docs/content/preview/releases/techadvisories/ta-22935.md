---
title: TA-22935
headerTitle: Inconsistencies between system catalog and DocDB schema during DDL operations
headcontent: 25 June 2024
type: docs
showRightNav: true
cascade:
  unversioned: true
menu:
  preview_releases:
    identifier: ta-22935
    weight: 1
rightNav:
  hideH2: true
type: docs
---

|          Product           |  Affected Versions  |  Related Issues   | Fixed In |
| :------------------------- | :------------------ | :---------------- | :------- |
| {{<product "ysql">}}       | {{<release "2.18.0.0, 2.20.0.0, 2024.1.0.0">}} | {{<issue 22935>}} | {{<release "2.18.9.0, 2.20.5.0, 2024.1.2.0">}} |

## Description

When server-side caching of sequences is enabled by setting the flag `ysql_sequence_cache_method = server`, it can cause errors for columns using the sequences if multiple databases are present in the cluster, or if a database is dropped and recreated. Columns using sequences as primary keys may incorrectly return duplicate key errors, and unique constraint violations may also occur if the column has a unique constraint.

This issue arises because the same TServer cache entry is used across multiple databases, and sequence cache entries are never invalidated, remaining in memory till the TServer is restarted.

## Mitigation

If the cluster has `ysql_sequence_cache_method = server` enabled, then update the flag to use `ysql_sequence_cache_method = connection`.

## Details

By default, YugabyteDB supports caching of the sequence values in each YSQL connection. Capability to support the caching of the sequence value on yb-tserver was added to improve the performance of sequences. This feature can be turned on by setting the GFLAG ysql_sequence_cache_method = server.  The default value for this flag is connection.

For Tserver caching, the cache key is the OID of the sequence objects. PostgreSQL maintains unique OIDs within the database and thus multiple databases can allocate the same OID.  This can cause the sequences in two different databases to have the same OID. Since the cache key is OID, hence the different sequences in different databases will continue to use the same cache key which results in such sequences sharing the same cache in Tserver.
With  ysql_sequence_cache_method = server, sequence cache entries are never invalidated and reside in memory until Tserver shutdown. Hence when a database containing the sequences is dropped and recreated then it also may return an error due to stale entries from dropped sequences.

## Examples
